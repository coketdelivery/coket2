<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- ëª¨ë°”ì¼ ìµœì í™” -->
  <title>ê±¸ì½”TV ì½”ì¼“ë°°ì†¡ í…ŒíŠ¸ë¦¬ìŠ¤ ê²Œì„</title>
  <style>
    body {
      background: #fff;
      color: #000;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      position: relative;
    }
    /* ë°ìŠ¤í¬íƒ‘ ê¸°ë³¸ ìº”ë²„ìŠ¤ í¬ê¸° */
    #gameCanvas {
      background: #000;
      border: 2px solid #000;
      margin: 20px auto;
      display: block;
      touch-action: none;
    }
    /* ëª¨ë°”ì¼ì—ì„œëŠ” ìº”ë²„ìŠ¤ ë„ˆë¹„ë¥¼ í™”ë©´ì— ë§ì¶° ì¡°ì • (ë†’ì´ëŠ” ë¹„ìœ¨ì— ë§ê²Œ) */
    @media (max-width: 600px) {
      #gameCanvas {
        width: 90vw;
        height: calc(90vw * 2); /* ì„¸ë¡œ:ê°€ë¡œë¹„ìœ¨ 2:1 (ì˜ˆ: ì›ë³¸ 300x600) */
      }
    }
    #scoreBoard, #timeBoard {
      margin: 10px;
      font-size: 20px;
    }
    /* ì˜¤ë²„ë ˆì´ (ê²Œì„ ì‹œì‘ ì•ˆë‚´ ë° ê²Œì„ ì˜¤ë²„ ì•ˆë‚´ë¥¼ ëª¨ë‘ í‘œì‹œ) */
    #overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 2px solid #000;
      padding: 20px;
      background: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      z-index: 10;
      width: 300px;
      max-width: 80%;
    }
    /* ì‹œì‘ ë²„íŠ¼(ì´ˆê¸°) / ì¬ì‹œì‘ ë²„íŠ¼(ê²Œì„ì˜¤ë²„ í›„) ê³µí†µ ìŠ¤íƒ€ì¼ */
    #overlay button {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 15px 30px;
      font-size: 24px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #overlay button:hover {
      background-color: #45a049;
    }

    /* ê²Œì„ í”Œë ˆì´ ì¤‘ ì¤‘ì•™ì— ëœ¨ëŠ” ë ˆë²¨ì—… ë©”ì‹œì§€ (ê¸€ì í¬ê¸° 20px) */
    #levelUpMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 2px solid white;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      font-size: 20px;
      font-weight: bold;
      display: none;
      z-index: 5;
    }
    #copyright {
      margin-top: 20px;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <!-- ì•ˆë‚´ ì œëª©/ë‚´ìš© (ì´ˆê¸° ì•ˆë‚´) -->
  <div id="overlay">
    <h2>â™¥ ì½”ì¼“ë°°ì†¡-í…ŒíŠ¸ë¦¬ìŠ¤ â™¥</h2>
    <p>ìœ íŠœë¸Œ 'ê±¸ì½”_Gulko' ì €ì‘ê¶Œ ì½˜í…ì¸ ì…ë‹ˆë‹¤.<br>
    <p>Â© 2025 ì½”ì¼“ê²Œì„ì¦ˆ. All rights reserved.<br>
      <a href="https://www.youtube.com/@Gulko" target="_blank">https://www.youtube.com/@Gulko</a></p>
       </a>
    </p>
    <button id="startButton" disabled>ê²Œì„ ì‹œì‘</button>
  </div>

  <!-- ê²Œì„ ìº”ë²„ìŠ¤ -->
  <canvas id="gameCanvas" width="300" height="600"></canvas>
  
  <!-- ê²Œì„ í”Œë ˆì´ ì¤‘ ë ˆë²¨ì—… ë©”ì‹œì§€ (í™”ë©´ ì¤‘ì•™) -->
  <div id="levelUpMessage"></div>

  <!-- ì ìˆ˜ì™€ ì‹œê°„ í‘œì‹œ -->
  <div id="scoreBoard">Score: 0</div>
  <div id="timeBoard">Time: 0:00</div>
  
  <!-- ì €ì‘ê¶Œ ë¬¸êµ¬ -->
  <div id="copyright">
    ìœ íŠœë¸Œ "ê±¸ì½”_Gulko"ì €ì‘ê¶Œ ì½˜í…ì¸ ì…ë‹ˆë‹¤. 
    <a href="https://www.youtube.com/@Gulko" target="_blank" style="color:#333;">https://www.youtube.com/@Gulko</a><br>
    Â© 2025 ì½”ì¼“ê²Œì„ì¦ˆ. All rights reserved.
  </div>

  <audio id="blockDropSound" src="drop_sound.mp3"></audio>
  <audio id="lineClearSound" src="clear_sound.mp3"></audio>
  <audio id="blockBottomSound" src="block_bottom.mp3"></audio>
  <audio id="levelUpSound" src="levelup_sound.mp3"></audio>
  <audio id="bgMusic" src="bg_music.mp3" loop></audio>

  <script>
    // DOM ìš”ì†Œ ë° ìº”ë²„ìŠ¤ ê°€ì ¸ì˜¤ê¸°
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreBoard = document.getElementById('scoreBoard');
    const timeBoard = document.getElementById('timeBoard');
    const startButton = document.getElementById('startButton');
    const overlay = document.getElementById('overlay');
    const levelUpMessageDiv = document.getElementById('levelUpMessage');
    const blockDropSound = document.getElementById('blockDropSound');
    const lineClearSound = document.getElementById('lineClearSound');
    const blockBottomSound = document.getElementById('blockBottomSound');
    const levelUpSound = document.getElementById('levelUpSound');
    const bgMusic = document.getElementById('bgMusic');

    // ë°°ê²½ ì´ë¯¸ì§€ ì¶”ê°€
    const backgroundImg = new Image();
    backgroundImg.src = 'background.jpg'; // ì˜ˆ: background.jpg

    // ê²Œì„ ê´€ë ¨ ë³€ìˆ˜
    let score = 0;
    let gameInterval;
    let gameSpeed = 1000; // ì´ˆê¸° ë¸”ë¡ ì´ë™ ì†ë„ (ms)
    let levelTimer = Date.now(); // ë‚œì´ë„ ì¡°ì ˆ ê¸°ì¤€ ì‹œê°„
    let level = 1; // ì´ˆê¸° ë ˆë²¨
    let startTime; // ê²Œì„ ì‹œì‘ ì‹œê°„

    // ê²Œì„ ë³´ë“œ (20í–‰ x 10ì—´)
    const ROWS = 20, COLS = 10;
    const BLOCK_SIZE = 30;
    let board = [];

    function initBoard() {
      board = [];
      for (let r = 0; r < ROWS; r++) {
        board[r] = new Array(COLS).fill(0);
      }
    }

    // í…ŒíŠ¸ë¡œë¯¸ë…¸ íƒ€ì… ë° ì´ë¯¸ì§€ ê°ì²´ ìƒì„±
    const blockTypes = ['I', 'O', 'T', 'S', 'Z', 'J', 'L'];
    const blockImages = {};
    blockTypes.forEach(type => {
      const img = new Image();
      img.src = type.toLowerCase() + '_block.png';
      blockImages[type] = img;
    });

    // í…ŒíŠ¸ë¡œë¯¸ë…¸ ëª¨ì–‘ ì •ì˜
    const shapes = {
      'I': [[1, 1, 1, 1]],
      'O': [[1, 1], [1, 1]],
      'T': [[0, 1, 0], [1, 1, 1]],
      'S': [[0, 1, 1], [1, 1, 0]],
      'Z': [[1, 1, 0], [0, 1, 1]],
      'J': [[1, 0, 0], [1, 1, 1]],
      'L': [[0, 0, 1], [1, 1, 1]]
    };

    // 'bag' ì•Œê³ ë¦¬ì¦˜: ë‚¨ì€ ë¸”ë¡ë“¤ì„ ì €ì¥í•˜ëŠ” ë°°ì—´
    let blockBag = [];
    function refillBag() {
      blockBag = [...blockTypes];
      // Fisher-Yates shuffle ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ì„ê¸°
      for (let i = blockBag.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [blockBag[i], blockBag[j]] = [blockBag[j], blockBag[i]];
      }
    }

    // í˜„ì¬ ë–¨ì–´ì§€ëŠ” ë¸”ë¡ ì •ë³´
    let currentBlock = {
      type: null,
      shape: null,
      x: 0,
      y: 0
    };

    // ìƒˆ ë¸”ë¡ ìƒì„± (bagì„ ì´ìš©) ë° ê²Œì„ ì˜¤ë²„ ì²´í¬
    function spawnBlock() {
      if (blockBag.length === 0) {
        refillBag();
      }
      currentBlock.type = blockBag.pop();
      currentBlock.shape = shapes[currentBlock.type] || [[1]];
      currentBlock.x = Math.floor((COLS - currentBlock.shape[0].length) / 2);
      currentBlock.y = 0;
      if (collision(currentBlock.x, currentBlock.y, currentBlock.shape)) {
        gameOver();
      }
    }

    // ì¶©ëŒ ê²€ì‚¬
    function collision(newX, newY, newShape) {
      for (let r = 0; r < newShape.length; r++) {
        for (let c = 0; c < newShape[r].length; c++) {
          if (newShape[r][c]) {
            let boardX = newX + c;
            let boardY = newY + r;
            if (boardX < 0 || boardX >= COLS || boardY >= ROWS) return true;
            if (boardY >= 0 && board[boardY][boardX]) return true;
          }
        }
      }
      return false;
    }

    // í˜„ì¬ ë¸”ë¡ì„ ë³´ë“œì— ê³ ì •
    function fixBlock() {
      const shape = currentBlock.shape;
      for (let r = 0; r < shape.length; r++) {
        for (let c = 0; c < shape[r].length; c++) {
          if (shape[r][c]) {
            let boardX = currentBlock.x + c;
            let boardY = currentBlock.y + r;
            if (boardY >= 0 && boardY < ROWS && boardX >= 0 && boardX < COLS) {
              board[boardY][boardX] = currentBlock.type;
            }
          }
        }
      }
      checkLineClear();
    }

    // ì¤„ ì‚­ì œ ë° ì ìˆ˜ ì—…ë°ì´íŠ¸
    function checkLineClear() {
      let linesCleared = 0;
      for (let r = 0; r < ROWS; r++) {
        if (board[r].every(cell => cell !== 0)) {
          board.splice(r, 1);
          board.unshift(new Array(COLS).fill(0));
          score += 100;
          linesCleared++;
        }
      }
      if (linesCleared > 0) {
        lineClearSound.play().catch(() => {});
      }
    }

    // ë¸”ë¡ì„ ì•„ë˜ë¡œ ì´ë™
    function moveBlockDown() {
      if (!collision(currentBlock.x, currentBlock.y + 1, currentBlock.shape)) {
        currentBlock.y++;
        blockDropSound.play().catch(() => {});
      } else {
        blockBottomSound.play().catch(() => {});
        fixBlock();
        spawnBlock();
      }
    }

    // ë ˆë²¨ì—… ë©”ì‹œì§€ í‘œì‹œ (í™”ë©´ ì¤‘ì•™ì— 3ì´ˆê°„ í‘œì‹œ)
    function showLevelUpMessage() {
      levelUpMessageDiv.textContent = "LEVEL " + level + " - ì‚¬ë‘í•©ë‹ˆë‹¤ ê³ ê°ë‹˜";
      levelUpMessageDiv.style.display = "block";
      levelUpSound.play().catch(() => {});
      setTimeout(() => {
        levelUpMessageDiv.style.display = "none";
      }, 3000);
    }

    // ë‚œì´ë„ ì¡°ì ˆ (30ì´ˆë§ˆë‹¤ ë ˆë²¨ ìƒìŠ¹, ì†ë„ 200msì”© ë¹¨ë¼ì§)
    function updateDifficulty() {
      const elapsed = Date.now() - levelTimer;
      if (elapsed >= 30000) {
        gameSpeed = Math.max(200, gameSpeed - 200);
        level++;
        showLevelUpMessage();
        clearInterval(gameInterval);
        gameInterval = setInterval(gameLoop, gameSpeed);
        levelTimer = Date.now();
      }
    }

    // ì ìˆ˜ ë° ì‹œê°„ ì—…ë°ì´íŠ¸
    function updateScoreAndTime() {
      scoreBoard.textContent = "Score: " + score;
      const totalSeconds = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      timeBoard.textContent = "Time: " + minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
    }

    // ë³´ë“œ ë° í˜„ì¬ ë¸”ë¡ ê·¸ë¦¬ê¸° (ë°°ê²½ ì´ë¯¸ì§€ í¬í•¨)
    function drawBoard() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(backgroundImg, 0, 0, canvas.width, canvas.height);
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          if (board[r][c]) {
            ctx.drawImage(
              blockImages[board[r][c]],
              c * BLOCK_SIZE,
              r * BLOCK_SIZE,
              BLOCK_SIZE,
              BLOCK_SIZE
            );
            ctx.strokeStyle = "#fff";
            ctx.strokeRect(c * BLOCK_SIZE, r * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
          }
        }
      }
    }

    function drawCurrentBlock() {
      const shape = currentBlock.shape;
      for (let r = 0; r < shape.length; r++) {
        for (let c = 0; c < shape[r].length; c++) {
          if (shape[r][c]) {
            let x = (currentBlock.x + c) * BLOCK_SIZE;
            let y = (currentBlock.y + r) * BLOCK_SIZE;
            ctx.drawImage(blockImages[currentBlock.type], x, y, BLOCK_SIZE, BLOCK_SIZE);
            ctx.strokeStyle = "#fff";
            ctx.strokeRect(x, y, BLOCK_SIZE, BLOCK_SIZE);
          }
        }
      }
    }

    function draw() {
      drawBoard();
      drawCurrentBlock();
    }

    function gameLoop() {
      moveBlockDown();
      updateDifficulty();
      updateScoreAndTime();
      draw();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   ê²Œì„ ì˜¤ë²„ ì‹œ ì˜¤ë²„ë ˆì´ì— ê²Œì„ì˜¤ë²„ ì•ˆë‚´ í‘œì‹œ
    //   + ì¬ì‹œì‘ ë²„íŠ¼ ì œê³µ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showGameOverOverlay() {
      overlay.innerHTML = `
        <h2>ê²Œì„ ì˜¤ë²„! ğŸ˜¢</h2>
        <p>ì½”íŒ¡ êµ¬ì…ì€ ê±¸ì½”ì™€í•¨ê»˜</p>
        <p><a href="https://www.youtube.com/@Gulko" target="_blank">
          https://www.youtube.com/@Gulko
        </a></p>
        <p>ì‚¬ë‘í•©ë‹ˆë‹¤. ê³ ê°ë‹˜</p>
        <button id="restartButton">ì¬ì‹œì‘</button>
      `;
      overlay.style.display = "flex";

      // ì¬ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
      const restartButton = document.getElementById('restartButton');
      restartButton.addEventListener('click', function() {
        // ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê³ 
        overlay.style.display = "none";
        // ìŒì•… ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì¬ìƒ
        bgMusic.currentTime = 0;
        bgMusic.play().catch(() => {});
        // ê²Œì„ ì´ˆê¸°í™”
        init();
      });
    }

    function gameOver() {
      clearInterval(gameInterval);
      levelUpMessageDiv.style.display = "none";
      // ë°°ê²½ìŒì•…ì„ ì¼ì‹œì •ì§€ í›„ ì²˜ìŒ ìœ„ì¹˜ë¡œ ëŒë ¤ ë†“ê¸° (ì¬ì‹œì‘ ì‹œ ë‹¤ì‹œ ì‹œì‘ë˜ë„ë¡)
      bgMusic.pause();
      bgMusic.currentTime = 0;
      showGameOverOverlay();
    }

    // ê²Œì„ ì´ˆê¸°í™” ë° ì‹œì‘
    function init() {
      score = 0;
      level = 1;
      gameSpeed = 1000;
      levelTimer = Date.now();
      startTime = Date.now();
      initBoard();
      refillBag();
      spawnBlock();
      // ê²Œì„ ë£¨í”„ ì‹œì‘
      gameInterval = setInterval(gameLoop, gameSpeed);
    }

    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ë°ìŠ¤í¬íƒ‘)
    document.addEventListener('keydown', function(event) {
      if (bgMusic.paused) bgMusic.play().catch(() => {});
      switch (event.key) {
        case 'ArrowLeft':
          if (!collision(currentBlock.x - 1, currentBlock.y, currentBlock.shape)) {
            currentBlock.x--;
          }
          break;
        case 'ArrowRight':
          if (!collision(currentBlock.x + 1, currentBlock.y, currentBlock.shape)) {
            currentBlock.x++;
          }
          break;
        case 'ArrowDown':
          moveBlockDown();
          break;
        case 'ArrowUp':
          let rotatedShape = rotateMatrix(currentBlock.shape);
          if (!collision(currentBlock.x, currentBlock.y, rotatedShape)) {
            currentBlock.shape = rotatedShape;
          }
          break;
      }
      draw();
    });

    // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
    let touchStartX = 0, touchStartY = 0, touchEndX = 0, touchEndY = 0;
    const swipeThreshold = 30;
    canvas.addEventListener('touchstart', function(e) {
      const touch = e.touches[0];
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
      if (bgMusic.paused) bgMusic.play().catch(() => {});
    });
    canvas.addEventListener('touchmove', function(e) {
      e.preventDefault();
      const touch = e.touches[0];
      touchEndX = touch.clientX;
      touchEndY = touch.clientY;
      // ì•„ë˜ë¡œ ìŠ¤ì™€ì´í”„ ì‹œ ë¹ ë¥¸ í•˜ê°•
      if (touchEndY - touchStartY > swipeThreshold) {
        moveBlockDown();
        draw();
        touchStartY = touchEndY; 
      }
    });
    canvas.addEventListener('touchend', function(e) {
      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;
      // ì¢Œìš° ìŠ¤ì™€ì´í”„
      if (Math.abs(deltaX) > Math.abs(deltaY)) {
        if (deltaX > swipeThreshold) {
          // ì˜¤ë¥¸ìª½ ì´ë™
          if (!collision(currentBlock.x + 1, currentBlock.y, currentBlock.shape)) {
            currentBlock.x++;
          }
        } else if (deltaX < -swipeThreshold) {
          // ì™¼ìª½ ì´ë™
          if (!collision(currentBlock.x - 1, currentBlock.y, currentBlock.shape)) {
            currentBlock.x--;
          }
        }
      } else {
        // ìœ„ë¡œ ìŠ¤ì™€ì´í”„ ì‹œ íšŒì „
        if (deltaY < -swipeThreshold) {
          let rotatedShape = rotateMatrix(currentBlock.shape);
          if (!collision(currentBlock.x, currentBlock.y, rotatedShape)) {
            currentBlock.shape = rotatedShape;
          }
        }
      }
      draw();
    });

    // í–‰ë ¬ íšŒì „ í•¨ìˆ˜ (ì‹œê³„ ë°©í–¥)
    function rotateMatrix(matrix) {
      let result = [];
      for (let c = 0; c < matrix[0].length; c++) {
        let newRow = [];
        for (let r = matrix.length - 1; r >= 0; r--) {
          newRow.push(matrix[r][c]);
        }
        result.push(newRow);
      }
      return result;
    }

    // ì´ë¯¸ì§€ ë¡œë“œ í™•ì¸: ëª¨ë“  ì´ë¯¸ì§€ ë¡œë“œ í›„ ì‹œì‘ ë²„íŠ¼ í™œì„±í™”
    let imagesLoaded = 0;
    const totalImages = blockTypes.length;
    blockTypes.forEach(type => {
      blockImages[type].onload = function() {
        imagesLoaded++;
        if (imagesLoaded === totalImages) {
          startButton.disabled = false;
          startButton.textContent = "ê²Œì„ ì‹œì‘";
        }
      };
    });
    startButton.disabled = true;
    startButton.textContent = "ë¡œë”©ì¤‘...";

    // ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ ì•ˆë‚´ ì°½ ìˆ¨ê¸°ê³  ê²Œì„ ì‹œì‘
    startButton.addEventListener('click', function() {
      overlay.style.display = "none";
      bgMusic.volume = 0.3;
      if (bgMusic.paused) bgMusic.play().catch(() => {});
      init();
    });
  </script>
</body>
</html>
